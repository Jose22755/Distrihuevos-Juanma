<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cambiar Contrase√±a - Distrihuevos JUANMA</title>
  <link rel="stylesheet" href="../css/login.css">
</head>
<body>
<div class="login-container">
  <div class="login-card">
    <div class="logo-container">
      <img src="../html/images/LogoDistrihuevosJUANMA_FINAL.png" alt="Logo" class="logo-register">
      <h1>Distrihuevos <span>JUANMA</span></h1>
    </div>

    <a href="index.html" class="back-link-card">‚Üê Volver</a>
    <h2 class="form-title">Cambiar Contrase√±a</h2>
    <div class="info-msg" style="text-align:center; margin-bottom:1.5rem;">
      Ingresa tu correo y tu contrase√±a actual para establecer una nueva.
    </div>

    <form id="reset-password-form">
      <label>Correo electr√≥nico
        <input type="email" id="email" required>
        <div id="emailError" class="error-msg"></div>
      </label>

      <label>Contrase√±a actual
        <div class="password-container">
          <input type="password" id="current-password" required>
          <span class="toggle-pass">üëÅÔ∏è</span>
        </div>
        <div id="currentPasswordError" class="error-msg"></div>
      </label>

      <label>Nueva Contrase√±a
        <div class="password-container">
          <input type="password" id="new-password" required>
          <span class="toggle-pass">üëÅÔ∏è</span>
        </div>
        <div id="newPasswordError" class="error-msg"></div>
      </label>

      <button type="submit">Cambiar Contrase√±a</button>
    </form>

    <a href="index.html" class="back-link">Volver a la p√°gina de inicio</a>
  </div>
</div>

<div id="reset-success-message">‚úÖ Contrase√±a actualizada correctamente</div>
<div id="spinner-overlay">
  <div class="spinner"></div>
  <div id="spinner-message">Procesando...</div>
</div>

<script type="module">
import { auth } from "../js/firebase-config.js";
import { EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

const resetForm = document.getElementById('reset-password-form');
const email = document.getElementById('email');
const currentPassword = document.getElementById('current-password');
const newPassword = document.getElementById('new-password');

const emailError = document.getElementById('emailError');
const currentPasswordError = document.getElementById('currentPasswordError');
const newPasswordError = document.getElementById('newPasswordError');
const successMessage = document.getElementById('reset-success-message');
const spinner = document.getElementById('spinner-overlay');

const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*]).{8,}$/;

// Toggle mostrar/ocultar contrase√±a
document.querySelectorAll('.toggle-pass').forEach(toggle => {
  toggle.addEventListener('click', () => {
    const input = toggle.previousElementSibling;
    input.type = input.type === 'password' ? 'text' : 'password';
  });
});

function validateField(input, errorEl) {
  const val = input.value.trim();
  let valid = true;
  let msg = "";

  if (!val) {
    valid = false;
    msg = "Este campo es obligatorio";
  } else {
    if (input === email && !emailRegex.test(val)) {
      valid = false;
      msg = "Correo inv√°lido (ej: ejemplo@correo.com)";
    }
    if (input === newPassword && !passwordRegex.test(val)) {
      valid = false;
      msg = "Contrase√±a: m√≠nimo 8 caracteres, may√∫scula, min√∫scula, n√∫mero y s√≠mbolo (!@#$%^&*)";
    }
  }

  if (!valid) {
    errorEl.textContent = msg;
    errorEl.style.display = "block";
    input.classList.add("invalid");
  } else {
    errorEl.textContent = "";
    errorEl.style.display = "none";
    input.classList.remove("invalid");
  }
  return valid;
}

// Validaci√≥n en tiempo real
[email, currentPassword, newPassword].forEach((input) => {
  const errorEl = input === email ? emailError :
                  input === currentPassword ? currentPasswordError :
                  newPasswordError;

  input.addEventListener('input', () => {
    validateField(input, errorEl);
    successMessage.classList.remove('show');
  });
});

resetForm.addEventListener('submit', async(e) => {
  e.preventDefault();

  let isValid = true;
  isValid &= validateField(email, emailError);
  isValid &= validateField(currentPassword, currentPasswordError);
  isValid &= validateField(newPassword, newPasswordError);

  if (!isValid) return;

  spinner.classList.add('show');

  try {
    const user = auth.currentUser;

    if (!user) {
      emailError.textContent = "Debes iniciar sesi√≥n primero.";
      emailError.style.display = "block";
      spinner.classList.remove('show');
      return;
    }

    if (user.email !== email.value.trim()) {
      emailError.textContent = "El correo no coincide con el usuario actual.";
      emailError.style.display = "block";
      spinner.classList.remove('show');
      return;
    }

    const credential = EmailAuthProvider.credential(user.email, currentPassword.value.trim());
    await reauthenticateWithCredential(user, credential);

    await updatePassword(user, newPassword.value.trim());

    spinner.classList.remove('show');
    successMessage.classList.add('show');
    resetForm.reset();
    setTimeout(() => successMessage.classList.remove('show'), 2500);

  } catch (error) {
    spinner.classList.remove('show');
    if (error.code === "auth/wrong-password") {
      currentPasswordError.textContent = "Contrase√±a actual incorrecta";
      currentPasswordError.style.display = "block";
    } else {
      console.error(error);
      currentPasswordError.textContent = "Error: " + error.message;
      currentPasswordError.style.display = "block";
    }
  }
});
</script>
</body>
</html>
